// grab our dom elements
let displayBox = document.querySelector('.current-exercise'),
  catalogBox = document.querySelector('.catalog-box'),
  resetButton = document.querySelector('.reset');

// Hide catalog box by default (will show as popup)
catalogBox.style.display = 'none';

// Add a settings button to trigger the popup
// Check if button already exists to avoid duplication on reload
if (!document.querySelector('.settings-button')) {
  let settingsButton = document.createElement('button');
  settingsButton.innerHTML = '⚙';
  settingsButton.className = 'settings-button';
  settingsButton.title = 'Customize Exercises';
  document.querySelector('.cell').appendChild(settingsButton);

  // Add event listener to show/hide the catalog box
  settingsButton.addEventListener('click', function () {
    if (catalogBox.style.display === 'none') {
      catalogBox.style.display = 'block'; // CSS handles positioning
    } else {
      catalogBox.style.display = 'none';
    }
  });
}

const EXERCISES_PER_BREAK = 3; // Number of exercises shown per break

// Define a default set of exercises
let catalog = {
  // Cycle 1: Spine & Upper Body (Desk Detox)
  ex05: { name: 'Neck Circles & Tilts', reps: 5, type: 'reps', description: 'Why: Releases tension in the upper traps and cervical spine. Benefit: Reduces "tech-neck" stiffness and improves range of motion for better posture.', image: 'عَنْ أَمِيرِ الْمُؤْمِنِينَ أَبِي حَفْصٍ عُمَرَ بْنِ الْخَطَّابِ رَضِيَ اللهُ عَنْهُ قَالَ: سَمِعْتُ رَسُولَ اللَّهِ صلى الله عليه وسلم يَقُولُ: " إنَّمَا الْأَعْمَالُ بِالنِّيَّاتِ، وَإِنَّمَا لِكُلِّ امْرِئٍ مَا نَوَى، فَمَنْ كَانَتْ هِجْرَتُهُ إلَى اللَّهِ وَرَسُولِهِ فَهِجْرَتُهُ إلَى اللَّهِ وَرَسُولِهِ، وَمَنْ كَانَتْ هِجْرَتُهُ لِدُنْيَا يُصِيبُهَا أَوْ امْرَأَةٍ يَنْكِحُهَا فَهِجْرَتُهُ إلَى مَا هَاجَرَ إلَيْهِ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex61: { name: 'Arm Circles', reps: 10, type: 'reps', description: 'Why: Mobilizes the shoulder capsule and opens the chest. Benefit: Counters the slumped-forward posture from desk work and improves overhead mobility.', image: 'عَنْ عُمَرَ رَضِيَ اللهُ عَنْهُ أَيْضًا قَالَ: " بَيْنَمَا نَحْنُ جُلُوسٌ عِنْدَ رَسُولِ اللَّهِ صلى الله عليه و سلم ذَاتَ يَوْمٍ، إذْ طَلَعَ عَلَيْنَا رَجُلٌ شَدِيدُ بَيَاضِ الثِّيَابِ، شَدِيدُ سَوَادِ الشَّعْرِ، لَا يُرَى عَلَيْهِ أَثَرُ السَّفَرِ، وَلَا يَعْرِفُهُ مِنَّا أَحَدٌ. حَتَّى جَلَسَ إلَى النَّبِيِّ صلى الله عليه و سلم . فَأَسْنَدَ رُكْبَتَيْهِ إلَى رُكْبَتَيْهِ، وَوَضَعَ كَفَّيْهِ عَلَى فَخِذَيْهِ، وَقَالَ: يَا مُحَمَّدُ أَخْبِرْنِي عَنْ الْإِسْلَامِ. فَقَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم الْإِسْلَامُ أَنْ تَشْهَدَ أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَتُقِيمَ الصَّلَاةَ، وَتُؤْتِيَ الزَّكَاةَ، وَتَصُومَ رَمَضَانَ، وَتَحُجَّ الْبَيْتَ إنْ اسْتَطَعْت إلَيْهِ سَبِيلًا. قَالَ: صَدَقْت . فَعَجِبْنَا لَهُ يَسْأَلُهُ وَيُصَدِّقُهُ! قَالَ: فَأَخْبِرْنِي عَنْ الْإِيمَانِ. قَالَ: أَنْ تُؤْمِنَ بِاَللَّهِ وَمَلَائِكَتِهِ وَكُتُبِهِ وَرُسُلِهِ وَالْيَوْمِ الْآخِرِ، وَتُؤْمِنَ بِالْقَدَرِ خَيْرِهِ وَشَرِّهِ. قَالَ: صَدَقْت. قَالَ: فَأَخْبِرْنِي عَنْ الْإِحْسَانِ. قَالَ: أَنْ تَعْبُدَ اللَّهَ كَأَنَّك تَرَاهُ، فَإِنْ لَمْ تَكُنْ تَرَاهُ فَإِنَّهُ يَرَاك. قَالَ: فَأَخْبِرْنِي عَنْ السَّاعَةِ. قَالَ: مَا الْمَسْئُولُ عَنْهَا بِأَعْلَمَ مِنْ السَّائِلِ. قَالَ: فَأَخْبِرْنِي عَنْ أَمَارَاتِهَا؟ قَالَ: أَنْ تَلِدَ الْأَمَةُ رَبَّتَهَا، وَأَنْ تَرَى الْحُفَاةَ الْعُرَاةَ الْعَالَةَ رِعَاءَ الشَّاءِ يَتَطَاوَلُونَ فِي الْبُنْيَانِ. ثُمَّ انْطَلَقَ، فَلَبِثْتُ مَلِيًّا، ثُمَّ قَالَ: يَا عُمَرُ أَتَدْرِي مَنْ السَّائِلُ؟. ‫‬قُلْتُ: اللَّهُ وَرَسُولُهُ أَعْلَمُ. قَالَ: فَإِنَّهُ جِبْرِيلُ أَتَاكُمْ يُعَلِّمُكُمْ دِينَكُمْ ". رَوَاهُ مُسْلِمٌ.' },
  ex43: { name: 'Camel Cat', reps: 10, type: 'reps', description: 'Why: Flexes and extends the entire spine. Benefit: Lubricates vertebral discs and releases tension in the lower and middle back.', image: 'عَنْ أَبِي عَبْدِ الرَّحْمَنِ عَبْدِ اللَّهِ بْنِ عُمَرَ بْنِ الْخَطَّابِ رَضِيَ اللَّهُ عَنْهُمَا قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: " بُنِيَ الْإِسْلَامُ عَلَى خَمْسٍ: شَهَادَةِ أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَإِقَامِ الصَّلَاةِ، وَإِيتَاءِ الزَّكَاةِ، وَحَجِّ الْبَيْتِ، وَصَوْمِ رَمَضَانَ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },

  // Cycle 2: Hip Mobility (Openers)
  ex57: { name: 'Hip CARs', reps: 5, type: 'reps', description: 'Why: Controlled Articular Rotations move the hip joint through its full range. Benefit: Improves joint health and identifies "sticky" spots in hip mobility.', image: 'عَنْ أَبِي عَبْدِ الرَّحْمَنِ عَبْدِ اللَّهِ بْنِ مَسْعُودٍ رَضِيَ اللهُ عَنْهُ قَالَ: حَدَّثَنَا رَسُولُ اللَّهِ صلى الله عليه و سلم -وَهُوَ الصَّادِقُ الْمَصْدُوقُ-: "إنَّ أَحَدَكُمْ يُجْمَعُ خَلْقُهُ فِي بَطْنِ أُمِّهِ أَرْبَعِينَ يَوْمًا نُطْفَةً، ثُمَّ يَكُونُ عَلَقَةً مِثْلَ ذَلِكَ، ثُمَّ يَكُونُ مُضْغَةً مِثْلَ ذَلِكَ، ثُمَّ يُرْسَلُ إلَيْهِ الْمَلَكُ فَيَنْفُخُ فِيهِ الرُّوحَ، وَيُؤْمَرُ بِأَرْبَعِ كَلِمَاتٍ: بِكَتْبِ رِزْقِهِ، وَأَجَلِهِ، وَعَمَلِهِ، وَشَقِيٍّ أَمْ سَعِيدٍ؛ فَوَاَللَّهِ الَّذِي لَا إلَهَ غَيْرُهُ إنَّ أَحَدَكُمْ لَيَعْمَلُ بِعَمَلِ أَهْلِ الْجَنَّةِ حَتَّى مَا يَكُونُ بَيْنَهُ وَبَيْنَهَا إلَّا ذِرَاعٌ فَيَسْبِقُ عَلَيْهِ الْكِتَابُ فَيَعْمَلُ بِعَمَلِ أَهْلِ النَّارِ فَيَدْخُلُهَا. وَإِنَّ أَحَدَكُمْ لَيَعْمَلُ بِعَمَلِ أَهْلِ النَّارِ حَتَّى مَا يَكُ يكونُ بَيْنَهُ وَبَيْنَهَا إلَّا ذِرَاعٌ فَيَسْبِقُ عَلَيْهِ الْكِتَابُ فَيَعْمَلُ بِعَمَلِ أَهْلِ الْجَنَّةِ فَيَدْخُلُهَا". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex23: { name: '90/90 Hip Rotations', reps: 60, type: 'time', description: 'Why: Targets internal and external rotation of the femur. Benefit: Critical for hip health in runners and cyclists to prevent compensations in the knees.', image: 'عَنْ أُمِّ الْمُؤْمِنِينَ أُمِّ عَبْدِ اللَّهِ عَائِشَةَ رَضِيَ اللَّهُ عَنْهَا، قَالَتْ: قَالَ: رَسُولُ اللَّهِ صلى الله عليه و سلم "مَنْ أَحْدَثَ فِي أَمْرِنَا هَذَا مَا لَيْسَ مِنْهُ فَهُوَ رَدٌّ [رَوَاهُ الْبُخَارِيُّ] ،[وَمُسْلِمٌ] وَفِي رِوَايَةٍ لِمُسْلِمٍ: مَنْ عَمِلَ عَمَلًا لَيْسَ عَلَيْهِ أَمْرُنَا فَهُوَ رَدٌّ".' },
  ex20: { name: 'Hip Openers', reps: 8, type: 'reps', description: 'Why: Stretches the adductors and deep hip flexors. Benefit: Reverses the shortening effects of prolonged sitting and improves stride length.', image: 'عَنْ أَبِي عَبْدِ اللَّهِ النُّعْمَانِ بْنِ بَشِيرٍ رَضِيَ اللَّهُ عَنْهُمَا، قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: "إنَّ الْحَلَالَ بَيِّنٌ، وَإِنَّ الْحَرَامَ بَيِّنٌ، وَبَيْنَهُمَا أُمُورٌ مُشْتَبِهَاتٌ لَا يَعْلَمُهُنَّ كَثِيرٌ مِنْ النَّاسِ، فَمَنْ اتَّقَى الشُّبُهَاتِ فَقْد اسْتَبْرَأَ لِدِينِهِ وَعِرْضِهِ، وَمَنْ وَقَعَ فِي الشُّبُهَاتِ وَقَعَ فِي الْحَرَامِ، كَالرَّاعِي يَرْعَى حَوْلَ الْحِمَى يُوشِكُ أَنْ يَرْتَعَ فِيهِ، أَلَا وَإِنَّ لِكُلِّ مَلِكٍ حِمًى، أَلَا وَإِنَّ حِمَى اللَّهِ مَحَارِمُهُ، أَلَا وَإِنَّ فِي الْجَسَدِ مُضْغَةً إذَا صَلَحَتْ صَلَحَ الْجَسَدُ كُلُّهُ، وَإذَا فَسَدَتْ فَسَدَ الْجَسَدُ كُلُّهُ، أَلَا وَهِيَ الْقَلْبُ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },

  // Cycle 3: Glute Activation
  ex14: { name: 'Clamshells', reps: 20, type: 'reps', description: 'Why: Isolates the gluteus medius. Benefit: Essential for knee stability; prevents the "knee cave" (valgus) during running and cycling.', image: 'عَنْ أَبِي رُقَيَّةَ تَمِيمِ بْنِ أَوْسٍ الدَّارِيِّ رَضِيَ اللهُ عَنْهُ أَنَّ النَّبِيَّ صلى الله عليه وسلم قَالَ: "الدِّينُ النَّصِيحَةُ." قُلْنَا: لِمَنْ؟ قَالَ: "لِلَّهِ، وَلِكِتَابِهِ، وَلِرَسُولِهِ، وَلِأَئِمَّةِ الْمُسْلِمِينَ وَعَامَّتِهِمْ." رَوَاهُ مُسْلِمٌ.' },
  ex39: { name: 'Single-Leg Glute Bridge', reps: 15, type: 'reps', description: 'Why: Teaches the glutes to extend the hip without using the lower back. Benefit: Improves running power and protects the lumbar spine from overworking.', image: 'عَنْ ابْنِ عُمَرَ رَضِيَ اللَّهُ عَنْهُمَا، أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: "أُمِرْتُ أَنْ أُقَاتِلَ النَّاسَ حَتَّى يَشْهَدُوا أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَيُقِيمُوا الصَّلَاةَ، وَيُؤْتُوا الزَّكَاةَ؛ فَإِذَا فَعَلُوا ذَلِكَ عَصَمُوا مِنِّي دِمَاءَهُمْ وَأَمْوَالَهُمْ إلَّا بِحَقِّ الْإِسْلَامِ، وَحِسَابُهُمْ عَلَى اللَّهِ تَعَالَى" . رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex18: { name: 'Banded Monster Walks', reps: 12, type: 'reps', description: 'Why: Provides lateral resistance to the hip abductors. Benefit: Improves pelvic stability and single-leg balance during the running gait.', image: 'عَنْ أَبِي هُرَيْرَةَ عَبْدِ الرَّحْمَنِ بْنِ صَخْرٍ رَضِيَ اللهُ عَنْهُ قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: "مَا نَهَيْتُكُمْ عَنْهُ فَاجْتَنِبُوهُ، وَمَا أَمَرْتُكُمْ بِهِ فَأْتُوا مِنْهُ مَا اسْتَطَعْتُمْ، فَإِنَّمَا أَهْلَكَ الَّذِينَ مِنْ قَبْلِكُمْ كَثْرَةُ مَسَائِلِهِمْ وَاخْتِلالُهُمْ عَلَى أَنْبِيَائِهِمْ ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },

  // Cycle 4: Foot & Ankle Foundation
  ex30: { name: 'Axis Board Toe Drive', reps: 60, type: 'time', description: 'Why: Uses the front Axis platform to isolate the hallux (big toe). Benefit: Dramatically improves "toe-off" propulsion for runners and stabilizes the pedal platform for cyclists.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "إنَّ اللَّهَ طَيِّبٌ لَا يَقْبَلُ إلَّا طَيِّبًا، وَإِنَّ اللَّهَ أَمَرَ الْمُؤْمِنِينَ بِمَا أَمَرَ بِهِ الْمُرْسَلِينَ فَقَالَ تَعَالَى: "يَا أَيُّهَا الرُّسُلُ كُلُوا مِنْ الطَّيِّبَاتِ وَاعْمَلُوا صَالِحًا"، وَقَالَ تَعَالَى: "يَا أَيُّهَا الَّذِينَ آمَنُوا كُلُوا مِنْ طَيِّبَاتِ مَا رَزَقْنَاكُمْ" ثُمَّ ذَكَرَ الرَّجُلَ يُطِيلُ السَّفَرَ أَشْعَثَ أَغْبَرَ يَمُدُّ يَدَيْهِ إلَى السَّمَاءِ: يَا رَبِّ! يَا رَبِّ! وَمَطْعَمُهُ حَرَامٌ، وَمَلْبَسُهُ حَرَامٌ، وَغُذِّيَ بِالْحَرَامِ، فَأَنَّى يُسْتَجَابُ لَهُ؟". رَوَاهُ مُسْلِمٌ.' },
  ex38: { name: 'Axis Board Arch Torsion', reps: 60, type: 'time', description: 'Why: Uses the split platforms to train the twist between forefoot and heel. Benefit: Restores the foot’s natural shock-absorption "spring" and optimizes wattage transfer in stiff cycling shoes.', image: 'عَنْ أَبِي مُحَمَّدٍ الْحَسَنِ بْنِ عَلِيِّ بْنِ أَبِي طَالِبٍ سِبْطِ رَسُولِ اللَّهِ صلى الله عليه و سلم وَرَيْحَانَتِهِ رَضِيَ اللَّهُ عَنْهُمَا، قَالَ: حَفِظْت مِنْ رَسُولِ اللَّهِ صلى الله عليه و سلم "دَعْ مَا يُرِيبُك إلَى مَا لَا يُرِيبُك". رَوَاهُ التِّرْمِذِيُّ وَالنَّسَائِيُّ.' },
  ex10: { name: 'Standing Calf Raises', reps: 30, type: 'time', description: 'Why: Strengthens the gastrocnemius and soleus. Benefit: Increases ankle power for "push-off" and protects the Achilles tendon.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "مِنْ حُسْنِ إسْلَامِ الْمَرْءِ تَرْكُهُ مَا لَا يَعْنِيهِ". رَوَاهُ التِّرْمِذِيُّ وَابْنُ مَاجَهْ.' },

  // Cycle 5: Core Stability (Anti-Rotation)
  ex04: { name: 'Dead Bug', reps: 10, type: 'reps', description: 'Why: Trains the core to remain stable while the limbs move. Benefit: Improves "pelvic tuck" and prevents lower back arching during high-fatigue running.', image: 'عَنْ أَبِي حَمْزَةَ أَنَسِ بْنِ مَالِكٍ رَضِيَ اللهُ عَنْهُ خَادِمِ رَسُولِ اللَّهِ صلى الله عليه و سلم عَنْ النَّبِيِّ صلى الله عليه و سلم قَالَ: "لَا يُؤْمِنُ أَحَدُكُمْ حَتَّى يُحِبَّ لِأَخِيهِ مَا يُحِبُّ لِنَفْسِهِ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex01: { name: 'Bird Dog', reps: 10, type: 'reps', description: 'Why: Strengthens the posterior chain and cross-body stability. Benefit: Improves coordination and lumbar stability for a balanced, efficient stride.', image: 'عَنْ ابْنِ مَسْعُودٍ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "لَا يَحِلُّ دَمُ امْرِئٍ مُسْلِمٍ [ يشهد أن لا إله إلا الله، وأني رسول الله] إلَّا بِإِحْدَى ثَلَاثٍ: الثَّيِّبُ الزَّانِي، وَالنَّفْسُ بِالنَّفْسِ، وَالتَّارِكُ لِدِينِهِ الْمُفَارِقُ لِلْجَمَاعَةِ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex35: { name: 'RNT with Band', reps: 15, type: 'reps', description: 'Why: Reactive Neuromuscular Training forces the body to stabilize against a pull. Benefit: Automatically corrects movement patterns like knee instability.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: "مَنْ كَانَ يُؤْمِنُ بِاَللَّهِ وَالْيَوْمِ الْآخِرِ فَلْيَقُلْ خَيْرًا أَوْ لِيَصْمُتْ، وَمَنْ كَانَ يُؤْمِنُ بِاَللَّهِ وَالْيَوْمِ الْآخِرِ فَلْيُكْرِمْ جَارَهُ، وَمَنْ كَانَ يُؤْمِنُ بِاَللَّهِ وَالْيَوْمِ الْآخِرِ فَلْيُكْرِمْ ضَيْفَهُ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },

  // Cycle 6: Lateral Stability
  ex56: { name: 'Side Plank', reps: 30, type: 'time', description: 'Why: Strengthens the obliques and quadratus lumborum. Benefit: Prevents "hip drop" during running, which causes IT band and knee issues.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ أَنَّ رَجُلًا قَالَ لِلنَّبِيِّ صلى الله عليه و سلم أَوْصِنِي. قَالَ: لَا تَغْضَبْ، فَرَدَّدَ مِرَارًا، قَالَ: لَا تَغْضَبْ". رَوَاهُ الْبُخَارِيُّ.' },
  ex48: { name: 'Copenhagen Side Plank', reps: 30, type: 'time', description: 'Why: Specifically targets the hip adductors (inner thighs). Benefit: Critical for groin health and pelvic stability in multidirectional movements.', image: 'عَنْ أَبِي يَعْلَى شَدَّادِ بْنِ أَوْسٍ رَضِيَ اللهُ عَنْهُ عَنْ رَسُولِ اللَّهِ صلى الله عليه و سلم قَالَ: "إنَّ اللَّهَ كَتَبَ الْإِحْسَانَ عَلَى كُلِّ شَيْءٍ، فَإِذَا قَتَلْتُمْ فَأَحْسِنُوا الْقِتْلَةَ، وَإِذَا ذَبَحْتُمْ فَأَحْسِنُوا الذِّبْحَةَ، وَلْيُحِدَّ أَحَدُكُمْ شَفْرَتَهُ، وَلْيُرِحْ ذَبِيحَتَهُ". رَوَاهُ مُسْلِمٌ.' },
  ex33: { name: 'Sidelying Hip Abduction', reps: 10, type: 'reps', description: 'Why: Pure glute medius isolation. Benefit: The most direct way to strengthen the "hip levelers" that keep you stable on one leg.', image: 'عَنْ أَبِي ذَرٍّ جُنْدَبِ بْنِ جُنَادَةَ، وَأَبِي عَبْدِ الرَّحْمَنِ مُعَاذِ بْنِ جَبَلٍ رَضِيَ اللَّهُ عَنْهُمَا، عَنْ رَسُولِ اللَّهِ صلى الله عليه و سلم قَالَ: "اتَّقِ اللَّهَ حَيْثُمَا كُنْت، وَأَتْبِعْ السَّيِّئَةَ الْحَسَنَةَ تَمْحُهَا، وَخَالِقْ النَّاسَ بِخُلُقٍ حَسَنٍ" . رَوَاهُ التِّرْمِذِيُّ.' },

  // Cycle 7: Linear Motion
  ex11: { name: 'Leg Swings', reps: 12, type: 'reps', description: 'Why: Dynamic stretch for the hamstrings and hip flexors. Benefit: Prepares the muscles for the full range of motion used in high-speed running.', image: 'عَنْ عَبْدِ اللَّهِ بْنِ عَبَّاسٍ رَضِيَ اللَّهُ عَنْهُمَا قَالَ: "كُنْت خَلْفَ رَسُولِ اللَّهِ صلى الله عليه و سلم يَوْمًا، فَقَالَ: يَا غُلَامِ! إنِّي أُعَلِّمُك كَلِمَاتٍ: احْفَظْ اللَّهَ يَحْفَظْك، احْفَظْ اللَّهَ تَجِدْهُ تُجَاهَك، إذَا سَأَلْت فَاسْأَلْ اللَّهَ، وَإِذَا اسْتَعَنْت فَاسْتَعِنْ بِاَللَّهِ، وَاعْلَمْ أَنَّ الْأُمَّةَ لَوْ اجْتَمَعَتْ عَلَى أَنْ يَنْفَعُوك بِشَيْءٍ لَمْ يَنْفَعُوك إلَّا بِشَيْءٍ قَدْ كَتَبَهُ اللَّهُ لك، وَإِنْ اجْتَمَعُوا عَلَى أَنْ يَضُرُّوك بِشَيْءٍ لَمْ يَضُرُّوك إلَّا بِشَيْءٍ قَدْ كَتَبَهُ اللَّهُ عَلَيْك؛ رُفِعَتْ الْأَقْلَامُ، وَجَفَّتْ الصُّحُفُ" . رَوَاهُ التِّرْمِذِيُّ.' },
  ex25: { name: 'Inchworms', reps: 8, type: 'reps', description: 'Why: Dynamically stretches the entire posterior chain while activating the core. Benefit: Improves flexibility in a functional, moving pattern rather than a static stretch.', image: 'عَنْ أَبِي مَسْعُودٍ عُقْبَةَ بْنِ عَمْرٍو الْأَنْصَارِيِّ الْبَدْرِيِّ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "إنَّ مِمَّا أَدْرَكَ النَّاسُ مِنْ كَلَامِ النُّبُوَّةِ الْأُولَى: إذَا لَمْ تَسْتَحِ فَاصْنَعْ مَا شِئْت" . رَوَاهُ الْبُخَارِيُّ.' },
  ex15: { name: 'Walking Quad Pulls', reps: 10, type: 'reps', description: 'Why: Stretches the quadriceps and psoas while moving. Benefit: Essential for clearing out "stiff legs" after a long run or a day of sitting.', image: 'عَنْ أَبِي عَمْرٍو وَقِيلَ: أَبِي عَمْرَةَ سُفْيَانَ بْنِ عَبْدِ اللَّهِ رَضِيَ اللهُ عَنْهُ قَالَ: "قُلْت: يَا رَسُولَ اللَّهِ! قُلْ لِي فِي الْإِسْلَامِ قَوْلًا لَا أَسْأَلُ عَنْهُ أَحَدًا غَيْرَك؛ قَالَ: قُلْ: آمَنْت بِاَللَّهِ ثُمَّ اسْتَقِمْ" . رَوَاهُ مُسْلِمٌ.' },

  // Cycle 8: Multi-Planar Motion
  ex51: { name: "World's Greatest Stretch", reps: 5, type: 'reps', description: 'Why: Combines a lunge, hamstring stretch, and thoracic rotation. Benefit: The gold standard for total body mobility; addresses almost every major running muscle.', image: 'عَنْ أَبِي عَبْدِ اللَّهِ جَابِرِ بْنِ عَبْدِ اللَّهِ الْأَنْصَارِيِّ رَضِيَ اللَّهُ عَنْهُمَا: "أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم سُئِلَ فَقَالَ: أَرَأَيْت إذَا صَلَّيْت الْمَكْتُوبَاتِ، وَصُمْت رَمَضَانَ، وَأَحْلَلْت الْحَلَالَ، وَحَرَّمْت الْحَرَامَ، وَلَمْ أَزِدْ عَلَى ذَلِكَ شَيْئًا؛ أَأَدْخُلُ الْجَنَّةَ؟ قَالَ: نَعَمْ". رَوَاهُ مُسْلِمٌ.' },
  ex54: { name: 'Walking Lunges with Rotation', reps: 10, type: 'reps', description: 'Why: Challenges balance while stretching the hip flexors and activating the core. Benefit: Improves the coordination of the upper and lower body under tension.', image: 'عَنْ أَبِي مَالِكٍ الْحَارِثِ بْنِ عَاصِمٍ الْأَشْعَرِيِّ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "الطَّهُورُ شَطْرُ الْإِيمَانِ، وَالْحَمْدُ لِلَّهِ تَمْلَأُ الْمِيزَانَ، وَسُبْحَانَ اللَّهِ وَالْحَمْدُ لِلَّهِ تَمْلَآنِ -أَوْ: تَمْلَأُ- مَا بَيْنَ السَّمَاءِ وَالْأَرْضِ، وَالصَّلَاةُ نُورٌ، وَالصَّدَقَةُ بُرْهَانٌ، وَالصَّبْرُ ضِيَاءٌ، وَالْقُرْآنُ حُجَّةٌ لَك أَوْ عَلَيْك، كُلُّ النَّاسِ يَغْدُو، فَبَائِعٌ نَفْسَهُ فَمُعْتِقُهَا أَوْ مُوبِقُهَا". رَوَاهُ مُسْلِمٌ.' },
  ex41: { name: 'Walking Hamstring Reaches', reps: 10, type: 'reps', description: 'Why: Dynamic, rhythmic stretch for the hamstrings. Benefit: Keeps the hamstrings long and reactive, reducing the risk of strains during uphill efforts.', image: 'عَنْ أَبِي ذَرٍّ الْغِفَارِيِّ رَضِيَ اللهُ عَنْهُ عَنْ النَّبِيِّ صلى الله عليه و سلم فِيمَا يَرْوِيهِ عَنْ رَبِّهِ تَبَارَكَ وَتَعَالَى، أَنَّهُ قَالَ: "يَا عِبَادِي: إنِّي حَرَّمْت الظُّلْمَ عَلَى نَفْسِي، وَجَعَلْته بَيْنَكُمْ مُحَرَّمًا؛ فَلَا تَظَالَمُوا. يَا عِبَادِي! كُلُّكُمْ ضَالٌّ إلَّا مَنْ هَدَيْته، فَاسْتَهْدُونِي أَهْدِكُمْ. يَا عِبَادِي! كُلُّكُمْ جَائِعٌ إلَّا مَنْ أَطْعَمْته، فَاسْتَطْعِمُونِي أُطْعِمْكُمْ. يَا عِبَادِي! كُلُّكُمْ عَارٍ إلَّا مَنْ كَسَوْته، فَاسْتَكْسُونِي أَكْسُكُمْ. يَا عِبَادِي! إنَّكُمْ تُخْطِئُونَ بِاللَّيْلِ وَالنَّهَارِ، وَأَنَا أَغْفِرُ الذُّنُوبَ جَمِيعًا؛ فَاسْتَغْفِرُونِي أَغْفِرْ لَكُمْ. يَا عِبَادِي! إنَّكُمْ لَنْ تَبْلُغُوا ضُرِّي فَتَضُرُّونِي، وَلَنْ تَبْلُغُوا نَفْعِي فَتَنْفَعُونِي. يَا عِبَادِي! لَوْ أَنَّ أَوَّلَكُمْ وَآخِرَكُمْ وَإِنْسَكُمْ وَجِنَّكُمْ كَانُوا عَلَى أَتْقَى قَلْبِ رَجُلٍ وَاحِدٍ مِنْكُمْ، مَا زَادَ ذَلِكَ فِي مُلْكِي شَيْئًا. يَا عِبَادِي! لَوْ أَنَّ أَوَّلَكُمْ وَآخِرَكُمْ وَإِنْسَكُمْ وَجِنَّكُمْ كَانُوا عَلَى أَفْجَرِ قَلْبِ رَجُلٍ وَاحِدٍ مِنْكُمْ، مَا نَقَصَ ذَلِكَ مِنْ مُلْكِي شَيْئًا. يَا عِبَادِي! لَوْ أَنَّ أَوَّلَكُمْ وَآخِرَكُمْ وَإِنْسَكُمْ وَجِنَّكُمْ قَامُوا فِي صَعِيدٍ وَاحِدٍ، فَسَأَلُونِي، فَأَعْطَيْت كُلَّ وَاحِدٍ مَسْأَلَته، مَا نَقَصَ ذَلِكَ مِمَّا عِنْدِي إلَّا كَمَا يَنْقُصُ الْمِخْيَطُ إذَا أُدْخِلَ الْبَحْرَ. يَا عِبَادِي! إنَّمَا هِيَ أَعْمَالُكُمْ أُحْصِيهَا لَكُمْ، ثُمَّ أُوَفِّيكُمْ إيَّاهَا؛ فَمَنْ وَجَدَ خَيْرًا فَلْيَحْمَدْ اللَّهَ، وَمَنْ وَجَدَ غَيْرَ ذَلِكَ فَلَا يَلُومَن إلَّا نَفْسَهُ". رَوَاهُ مُسْلِمٌ.' },

  // Cycle 9: Squat Pattern
  ex06: { name: 'Bulgarian Split Squat', reps: 10, type: 'reps', description: 'Why: Massive load on the glutes and quads while stretching the rear hip flexor. Benefit: Fixes leg imbalances and builds profound single-leg strength.', image: 'عَنْ أَبِي ذَرٍّ رَضِيَ اللهُ عَنْهُ أَيْضًا، "أَنَّ نَاسًا مِنْ أَصْحَابِ رَسُولِ اللَّهِ صلى الله عليه و سلم قَالُوا لِلنَّبِيِّ صلى الله عليه و سلم يَا رَسُولَ اللَّهِ ذَهَبَ أَهْلُ الدُّثُورِ بِالْأُجُورِ؛ يُصَلُّونَ كَمَا نُصَلِّي، وَيَصُومُونَ كَمَا نَصُومُ، وَيَتَصَدَّقُونَ بِفُضُولِ أَمْوَالِهِمْ. قَالَ: أَوَلَيْسَ قَدْ جَعَلَ اللَّهُ لَكُمْ مَا تَصَّدَّقُونَ؟ إنَّ بِكُلِّ تَسْبِيحَةٍ صَدَقَةً، وَكُلِّ تَكْبِيرَةٍ صَدَقَةً، وَكُلِّ تَهْلِيلَةٍ صَدَقَةً، وَأَمْرٌ بِمَعْرُوفٍ صَدَقَةٌ، وَنَهْيٌ عَنْ مُنْكَرٍ صَدَقَةٌ، وَفِي بُضْعِ أَحَدِكُمْ صَدَقَةٌ. قَالُوا: يَا رَسُولَ اللَّهِ أَيَأْتِي أَحَدُنَا شَهْوَتَهُ وَيَكُونُ لَهُ فِيهَا أَجْرٌ؟ قَالَ: أَرَأَيْتُمْ لَوْ وَضَعَهَا فِي حَرَامٍ أَكَانَ عَلَيْهِ وِزْرٌ؟ فَكَذَلِكَ إذَا وَضَعَهَا فِي الْحَلَالِ، كَانَ لَهُ أَجْرٌ". رَوَاهُ مُسْلِمٌ.' },
  ex24: { name: 'Kettlebell Squat', reps: 12, type: 'reps', description: 'Why: Builds global leg strength and core rigidity. Benefit: Protects the knees and improves power output during the "climbing" phase of cycling.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "كُلُّ سُلَامَى مِنْ النَّاسِ عَلَيْهِ صَدَقَةٌ، كُلَّ يَوْمٍ تَطْلُعُ فِيهِ الشَّمْسُ تَعْدِلُ بَيْنَ اثْنَيْنِ صَدَقَةٌ، وَتُعِينُ الرَّجُلَ فِي دَابَّتِهِ فَتَحْمِلُهُ عَلَيْهَا أَوْ تَرْفَعُ لَهُ عَلَيْهَا مَتَاعَهُ صَدَقَةٌ، وَالْكَلِمَةُ الطَّيِّبَةُ صَدَقَةٌ، وَبِكُلِّ خُطْوَةٍ تَمْشِيهَا إلَى الصَّلَاةِ صَدَقَةٌ، وَتُمِيطُ الْأَذَى عَنْ الطَّرِيقِ صَدَقَةٌ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex32: { name: 'Wall Sit', reps: 30, type: 'time', description: 'Why: Isometric hold for the quads and glutes. Benefit: Builds mental toughness and creates stability in the knee joint through controlled tension.', image: 'عَنْ النَّوَّاسِ بْنِ سَمْعَانَ رَضِيَ اللهُ عَنْهُ عَنْ النَّبِيِّ صلى الله عليه و سلم قَالَ: "الْبِرُّ حُسْنُ الْخُلُقِ، وَالْإِثْمُ مَا حَاكَ فِي صَدْرِك، وَكَرِهْت أَنْ يَطَّلِعَ عَلَيْهِ النَّاسُ" رَوَاهُ مُسْلِمٌ. وَعَنْ وَابِصَةَ بْنِ مَعْبَدٍ رَضِيَ اللهُ عَنْهُ قَالَ: أَتَيْت رَسُولَ اللَّهِ صلى الله عليه و سلم فَقَالَ: "جِئْتَ تَسْأَلُ عَنْ الْبِرِّ؟ قُلْت: نَعَمْ. فقَالَ: استفت قلبك، الْبِرُّ مَا اطْمَأَنَّتْ إلَيْهِ النَّفْسُ، وَاطْمَأَنَّ إلَيْهِ الْقَلْبُ، وَالْإِثْمُ مَا حَاكَ فِي النَّفْسِ وَتَرَدَّدَ فِي الصَّدْرِ، وَإِنْ أَفْتَاك النَّاسُ وَأَفْتَوْك" . رَوَاهُ أَحْمَدُ وَالدَّارِمِيُّ.' },

  // Cycle 10: Lunge Pattern
  ex36: { name: 'Lunges (Backward/Forward)', reps: 12, type: 'reps', description: 'Why: Trains deceleration and coordination. Benefit: Replicates the landing and push-off phases of the gait cycle.', image: 'عَنْ أَبِي نَجِيحٍ الْعِرْبَاضِ بْنِ سَارِيَةَ رَضِيَ اللهُ عَنْهُ قَالَ: "وَعَظَنَا رَسُولُ اللَّهِ صلى الله عليه و سلم مَوْعِظَةً وَجِلَتْ مِنْهَا الْقُلُوبُ، وَذَرَفَتْ مِنْهَا الْعُيُونُ، فَقُلْنَا: يَا رَسُولَ اللَّهِ! كَأَنَّهَا مَوْعِظَةُ مُوَدِّعٍ فَأَوْصِنَا، قَالَ: أُوصِيكُمْ بِتَقْوَى اللَّهِ، وَالسَّمْعِ وَالطَّاعَةِ وَإِنْ تَأَمَّرَ عَلَيْكُمْ عَبْدٌ، فَإِنَّهُ مَنْ يَعِشْ مِنْكُمْ فَسَيَرَى اخْتِلَافًا كَثِيرًا، فَعَلَيْكُمْ بِسُنَّتِي وَسُنَّةِ الْخُلَفَاءِ الرَّاشِدِينَ الْمَهْدِيينَ، عَضُّوا عَلَيْهَا بِالنَّوَاجِذِ، وَإِيَّاكُمْ وَمُحْدَثَاتِ الْأُمُورِ ؛ فَإِنَّ كُلَّ بِدْعَةٍ ضَلَالَةٌ". رَوَاهُ أَبُو دَاوُدَ وَاَلتِّرْمِذِيُّ.' },
  ex07: { name: 'Lateral Lunges', reps: 10, type: 'reps', description: 'Why: Strengthens the glute medius and adductors in the frontal plane. Benefit: Crucial for preventing "side-to-side" instability that leads to knee pain.', image: 'عَنْ مُعَاذِ بْنِ جَبَلٍ رَضِيَ اللهُ عَنْهُ قَالَ: قُلْت يَا رَسُولَ اللَّهِ! أَخْبِرْنِي بِمَعْمَلٍ يُدْخِلُنِي الْجَنَّةَ وَيُبَاعِدْنِي مِنْ النَّارِ، قَالَ: "لَقَدْ سَأَلْت عَنْ عَظِيمٍ، وَإِنَّهُ لَيَسِيرٌ عَلَى مَنْ يَسَّرَهُ اللَّهُ عَلَيْهِ: تَعْبُدُ اللَّهَ لَا تُشْرِكْ بِهِ شَيْئًا، وَتُقِيمُ الصَّلَاةَ، وَتُؤْتِي الزَّكَاةَ، وَتَصُومَ رَمَضَانَ، وَتَحُجَّ الْبَيْتَ، ثُمَّ قَالَ: أَلَا أَدُلُّك عَلَى أَبْوَابِ الْخَيْرِ؟ الصَّوْمُ جُنَّةٌ، وَالصَّدَقَةُ تُطْفِئُ الْخَطِيئَةَ كَمَا تُطْفِئُ النَّارَ، وَصَلَاةُ الرَّجُلِ فِي جَوْفِ اللَّيْلِ، ثُمَّ تَلَا: " تَتَجَافَى جُنُوبُهُمْ عَنِ الْمَضَاجِعِ " حَتَّى بَلَغَ "يَعْمَلُونَ"، ثُمَّ قَالَ: أَلَا أُخْبِرُك بِرَأْسِ الْأَمْرِ وَعَمُودِهِ وَذُرْوَةِ سَنَامِهِ؟ قُلْت: بَلَى يَا رَسُولَ اللَّهِ. قَالَ: رَأْسُ الْأَمْر الْإِسْلَامُ، وَعَمُودُهُ الصَّلَاةُ، وَذُرْوَةِ سَنَامِهِ الْجِهَادُ، ثُمَّ قَالَ: أَلَا أُخْبِرُك بِمَلَاكِ ذَلِكَ كُلِّهِ؟ فقُلْت: بَلَى يَا رَسُولَ اللَّهِ ! فَأَخَذَ بِلِسَانِهِ وَقَالَ: كُفَّ عَلَيْك هَذَا. قُلْت: يَا نَبِيَّ اللَّهِ وَإِنَّا لَمُؤَاخَذُونَ بِمَا نَتَكَلَّمُ بِهِ؟ فَقَالَ: ثَكِلَتْك أُمُّك وَهَلْ يَكُبُّ النَّاسَ عَلَى وُجُوهِهِمْ -أَوْ قَالَ عَلَى مَنَاخِرِهِمْ- إلَّا حَصَائِدُ أَلْسنتِهِمْ؟!" . رَوَاهُ التِّرْمِذِيُّ.' },
  ex22: { name: 'Step-Ups', reps: 10, type: 'reps', description: 'Why: Pure unilateral concentric strength. Benefit: Builds the "climbing" strength needed for hills and stairs.', image: 'عَنْ أَبِي ثَعْلَبَةَ الْخُشَنِيِّ جُرْثُومِ بن نَاشِر رَضِيَ اللهُ عَنْهُ عَنْ رَسُولِ اللَّهِ صلى الله عليه و سلم قَال: "إنَّ اللَّهَ تَعَالَى فَرَضَ فَرَائِضَ فَلَا تُضَيِّعُوهَا، وَحَدَّ حُدُودًا فَلَا تَعْتَدُوهَا، وَحَرَّمَ أَشْيَاءَ فَلَا تَنْتَهِكُوهَا، وَسَكَتَ عَنْ أَشْيَاءَ رَحْمَةً لَكُمْ غَيْرَ نِسْيَانٍ فَلَا تَبْحَثُوا عَنْهَا". رَوَاهُ الدَّارَقُطْنِيُّ.' },

  // Cycle 11: Hinge Pattern (Posterior Chain)
  ex16: { name: 'Romanian Deadlift', reps: 12, type: 'reps', description: 'Why: Targets the hamstrings and glutes in a lengthened position. Benefit: Essential for posterior chain "stiffness" and energy transfer in the running stride.', image: 'عَنْ أَبِي الْعَبَّاسِ سَهْلِ بْنِ سَعْدٍ السَّاعِدِيّ رَضِيَ اللهُ عَنْهُ قَالَ: جَاءَ رَجُلٌ إلَى النَّبِيِّ صلى الله عليه و سلم فَقَالَ: يَا رَسُولَ اللهِ! دُلَّنِي عَلَى عَمَلٍ إذَا عَمِلْتُهُ أَحَبَّنِي اللهُ وَأَحَبَّنِي النَّاسُ؛ فَقَالَ: "ازْهَدْ فِي الدُّنْيَا يُحِبَّك اللهُ، وَازْهَدْ فِيمَا عِنْدَ النَّاسِ يُحِبَّك النَّاسُ" . رَوَاهُ ابْنُ مَاجَهْ.' },
  ex45: { name: 'Single-Leg Deadlift', reps: 10, type: 'reps', description: 'Why: Challenges balance while loading the posterior chain. Benefit: The ultimate exercise for foot, ankle, and hip stability in one movement.', image: 'عَنْ أَبِي سَعِيدٍ سَعْدِ بْنِ مَالِكِ بْنِ سِنَانٍ الْخُدْرِيّ رَضِيَ اللهُ عَنْهُ أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: " لَا ضَرَرَ وَلَا ضِرَارَ" . رَوَاهُ ابْنُ مَاجَهْ وَالدَّارَقُطْنِيُّ.' },
  ex26: { name: 'Hamstrings Curl (Stability Ball)', reps: 12, type: 'reps', description: 'Why: Isolates the hamstrings and challenges pelvic stability. Benefit: Prevents hamstring tendonitis by strengthening the muscle in its most vulnerable positions.', image: 'عَنْ ابْنِ عَبَّاسٍ رَضِيَ اللَّهُ عَنْهُمَا أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: "لَوْ يُعْطَى النَّاسُ بِدَعْوَاهُمْ لَادَّعَى رِجَالٌ أَمْوَالَ قَوْمٍ وَدِمَاءَهُمْ، لَكِنَّ الْبَيِّنَةَ عَلَى الْمُدَّعِي، وَالْيَمِينَ عَلَى مَنْ أَنْكَرَ" . رَوَاهُ الْبَيْهَقِيُّ.' },

  // Cycle 12: Plyometrics (Power)
  ex19: { name: 'Single Leg Hops', reps: 10, type: 'reps', description: 'Why: Builds reactive strength and ankle stiffness. Benefit: Improves the "spring" in your step, making each stride more efficient.', image: 'عَنْ أَبِي سَعِيدٍ الْخُدْرِيّ رَضِيَ اللهُ عَنْهُ قَالَ سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: "مَنْ رَأَى مِنْكُمْ مُنْكَرًا فَلْيُغَيِّرْهُ بِيَدِهِ، فَإِنْ لَمْ يَسْتَطِعْ فَبِلِسَانِهِ، فَإِنْ لَمْ يَسْتَطِعْ فَبِقَلْبِهِ، وَذَلِكَ أَضْعَفُ الْإِيمَانِ" . رَوَاهُ مُسْلِمٌ.' },
  ex13: { name: 'Squat Jumps', reps: 10, type: 'reps', description: 'Why: Explosive power for the lower body. Benefit: Recruits fast-twitch muscle fibers for sprinting and powerful hill climbs.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم " لَا تَحَاسَدُوا، وَلَا تَنَاجَشُوا، وَلَا تَبَاغَضُوا، وَلَا تَدَابَرُوا، وَلَا يَبِعْ بَعْضُكُمْ عَلَى بَيْعِ بَعْضٍ، وَكُونُوا عِبَادَ اللَّهِ إخْوَانًا، الْمُسْلِمُ أَخُو الْمُسْلِمِ، لَا يَظْلِمُهُ، وَلَا يَخْذُلُهُ، وَلَا يَكْذِبُهُ، وَلَا يَحقِرُهُ، التَّقْوَى هَاهُنَا، وَيُشِيرُ إلَى صَدْرِهِ ثَلَاثَ مَرَّاتٍ، بِحَسْبِ امْرِئٍ مِنْ الشَّرِّ أَنْ يَحْقِرَ أَخَاهُ الْمُسْلِمَ، كُلُّ الْمُسْلِمِ عَلَى الْمُسْلِمِ حَرَامٌ: دَمُهُ وَمَالُهُ وَعِرْضُهُ" . رَوَاهُ مُسْلِمٌ.' },
  ex17: { name: 'Jumping Lunges', reps: 10, type: 'reps', description: 'Why: Explosive power from a split-stance position. Benefit: Improves stability and power during high-speed directional changes.', image: 'عَنْ أَبِي هُرَيْرَةَ رَضِيَ اللهُ عَنْهُ عَنْ النَّبِيِّ صلى الله عليه و سلم قَالَ: "مَنْ نَفَّسَ عَنْ مُؤْمِنٍ كُرْبَةً مِنْ كُرَبِ الدُّنْيَا نَفَّسَ اللَّهُ عَنْهُ كُرْبَةً مِنْ كُرَبِ يَوْمِ الْقِيَامَةِ، وَمَنْ يَسَّرَ عَلَى مُعْسِرٍ، يَسَّرَ اللَّهُ عَلَيْهِ فِي الدُّنْيَا وَالْآخِرَةِ، وَمَنْ سَتَرَ مُسْلِما سَتَرَهُ اللهُ فِي الدُّنْيَا وَالْآخِرَةِ ، وَاَللَّهُ فِي عَوْنِ الْعَبْدِ مَا كَانَ الْعَبْدُ فِي عَوْنِ أَخِيهِ، وَمَنْ سَلَكَ طَرِيقًا يَلْتَمِسُ فِيهِ عِلْمًا سَهَّلَ اللَّهُ لَهُ بِهِ طَرِيقًا إلَى الْجَنَّةِ، وَمَا اجْتَمَعَ قَوْمٌ فِي بَيْتٍ مِنْ بُيُوتِ اللَّهِ يَتْلُونَ كِتَابَ اللَّهِ، وَيَتَدَارَسُونَهُ فِيمَا بَيْنَهُمْ؛ إلَّا نَزَلَتْ عَلَيْهِمْ السَّكِينَةُ، وَغَشِيَتْهُمْ الرَّحْمَةُ، وَ حَفَّتهُمُ المَلاَئِكَة، وَذَكَرَهُمْ اللَّهُ فِيمَنْ عِنْدَهُ، وَمَنْ أَبَطْأَ بِهِ عَمَلُهُ لَمْ يُسْرِعْ بِهِ نَسَبُهُ". رَوَاهُ مُسْلِمٌ.' },

  // Cycle 13: Upper Body (Runner's Carriage)
  ex08: { name: 'Push-ups', reps: 15, type: 'reps', description: 'Why: Overall upper body and core stability. Benefit: A strong upper body maintains form and prevents fatigue-related slouching in long runs.', image: 'عَنْ ابْنِ عَبَّاسٍ رَضِيَ اللَّهُ عَنْهُمَا عَنْ رَسُولِ اللَّهِ صلى الله عليه و سلم فِيمَا يَرْوِيهِ عَنْ رَبِّهِ تَبَارَكَ وَتَعَالَى، قَالَ: "إنَّ اللَّهَ كَتَبَ الْحَسَنَاتِ وَالسَّيِّئَاتِ، ثُمَّ بَيَّنَ ذَلِكَ، فَمَنْ هَمَّ بِحَسَنَةٍ فَلَمْ يَعْمَلْهَا كَتَبَهَا اللَّهُ عِنْدَهُ حَسَنَةً كَامِلَةً، وَإِنْ هَمَّ بِهَا فَعَمِلَهَا كَتَبَهَا اللَّهُ عِنْدَهُ عَشْرَ حَسَنَاتٍ إلَى سَبْعِمِائَةِ ضِعْفٍ إلَى أَضْعَافٍ كَثِيرَةٍ، وَإِنْ هَمَّ بِسَيِّئَةٍ فَلَمْ يَعْمَلْهَا كَتَبَهَا اللَّهُ عِنْدَهُ حَسَنَةً كَامِلَةً، وَإِنْ هَمَّ بِهَا فَعَمِلَهَا كَتَبَهَا اللَّهُ سَيِّئَةً وَاحِدَةً". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex42: { name: 'One Arm Rows', reps: 12, type: 'reps', description: 'Why: Strengthens the mid-back and rhomboids. Benefit: Reverses desk-job posture and improves the "arm drive" during running.', image: 'عَنْ أَبِي هُرَيْرَة رَضِيَ اللهُ عَنْهُ قَالَ: قَالَ رَسُول اللَّهِ صلى الله عليه و سلم إنَّ اللَّهَ تَعَالَى قَالَ: "مَنْ عَادَى لِي وَلِيًّا فَقْد آذَنْتهُ بِالْحَرْبِ، وَمَا تَقَرَّبَ إلَيَّ عَبْدِي بِشَيْءٍ أَحَبَّ إلَيَّ مِمَّا افْتَرَضْتُهُ عَلَيْهِ، وَلَا يَزَالُ عَبْدِي يَتَقَرَّبُ إلَيَّ بِالنَّوَافِلِ حَتَّى أُحِبَّهُ، فَإِذَا أَحْبَبْتُهُ كُنْت سَمْعَهُ الَّذِي يَسْمَعُ بِهِ، وَبَصَرَهُ الَّذِي يُبْصِرُ بِهِ، وَيَدَهُ الَّتِي يَبْطِشُ بِهَا، وَرِجْلَهُ الَّتِي يَمْشِي بِهَا، وَلَئِنْ سَأَلَنِي لَأُعْطِيَنَّهُ، وَلَئِنْ اسْتَعَاذَنِي لَأُعِيذَنَّهُ". رَوَاهُ الْبُخَارِيُّ.' },
  ex46: { name: 'Dips', reps: 12, type: 'reps', description: 'Why: Strengthens the triceps and stabilizes the shoulder. Benefit: Complements the pulling muscles to ensure balanced upper body tension.', image: 'عَنْ ابْنِ عَبَّاسٍ رَضِيَ اللَّهُ عَنْهُمَا أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: "إنَّ اللَّهَ تَجَاوَزَ لِي عَنْ أُمَّتِي الْخَطَأَ وَالنِّسْيَانَ وَمَا اسْتُكْرِهُوا عَلَيْهِ" . رَوَاهُ ابْنُ مَاجَهْ وَالْبَيْهَقِيُّ.' },

  // Cycle 14: Single Leg Control
  ex12: { name: 'Hip Airplanes', reps: 6, type: 'reps', description: 'Why: Trains rotational control of the hip on a stable leg. Benefit: The ultimate "prehab" for hip stability and pelvic alignment.', image: 'عَنْ ابْن عُمَرَ رَضِيَ اللَّهُ عَنْهُمَا قَالَ: أَخَذَ رَسُولُ اللَّهِ صلى الله عليه و سلم بِمَنْكِبِي، وَقَالَ: "كُنْ فِي الدُّنْيَا كَأَنَّك غَرِيبٌ أَوْ عَابِرُ سَبِيلٍ". رَوَاهُ الْبُخَارِيُّ.' },
  ex58: { name: 'Lateral Step-Downs', reps: 12, type: 'reps', description: 'Why: Eccentric control of the knee and hip. Benefit: Specifically prevents "runner\'s knee" by training the glutes to control the knee\'s path.', image: 'عَنْ أَبِي مُحَمَّدٍ عَبْدِ اللَّهِ بْنِ عَمْرِو بْنِ الْخَطَّابِ رَضِيَ اللَّهُ عَنْهُمَا قَالَ: قَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم "لَا يُؤْمِنُ أَحَدُكُمْ حَتَّى يَكُونَ هَوَاهُ تَبَعًا لِمَا جِئْتُ بِهِ". رَوَيْنَاهُ فِي كِتَابِ الْحُجَّةِ بِإِسْنَادٍ صَحِيحٍ.' },
  ex03: { name: 'Single-leg Balance', reps: 30, type: 'time', description: 'Why: Proprioceptive training for the foot and ankle. Benefit: Reduces the risk of ankle sprains by improving the body\'s awareness of joint position.', image: 'عَنْ أَنَسِ بْنِ مَالِكٍ رَضِيَ اللهُ عَنْهُ قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: قَالَ اللَّهُ تَعَالَى: "يَا ابْنَ آدَمَ! إِنَّكَ مَا دَعَوْتنِي وَرَجَوْتنِي غَفَرْتُ لَك عَلَى مَا كَانَ مِنْك وَلَا أُبَالِي، يَا ابْنَ آدَمَ! لَوْ بَلَغَتْ ذُنُوبُك عَنَانَ السَّمَاءِ ثُمَّ اسْتَغْفَرْتنِي غَفَرْتُ لَك، يَا ابْنَ آدَمَ! إنَّك لَوْ أتَيْتنِي بِقُرَابِ الْأَرْضِ خَطَايَا ثُمَّ لَقِيتنِي لَا تُشْرِكُ بِي شَيْئًا لَأَتَيْتُك بِقُرَابِهَا مَغْفِرَةً" . رَوَاهُ التِّرْمِذِيُّ.' },

  // Cycle 15: Foam Rolling (Tissue Quality)
  ex09: { name: 'Foam Rolling Quad', reps: 60, type: 'time', description: 'Why: Myofascial release for the front of the thigh. Benefit: Reduces muscle tightness and improves blood flow to recovery areas.', image: 'عَنْ أَمِيرِ الْمُؤْمِنِينَ أَبِي حَفْصٍ عُمَرَ بْنِ الْخَطَّابِ رَضِيَ اللهُ عَنْهُ قَالَ: سَمِعْتُ رَسُولَ اللَّهِ صلى الله عليه وسلم يَقُولُ: " إنَّمَا الْأَعْمَالُ بِالنِّيَّاتِ، وَإِنَّمَا لِكُلِّ امْرِئٍ مَا نَوَى، فَمَنْ كَانَتْ هِجْرَتُهُ إلَى اللَّهِ وَرَسُولِهِ فَهِجْرَتُهُ إلَى اللَّهِ وَرَسُولِهِ، وَمَنْ كَانَتْ هِجْرَتُهُ لِدُنْيَا يُصِيبُهَا أَوْ امْرَأَةٍ يَنْكِحُهَا فَهِجْرَتُهُ إلَى مَا هَاجَرَ إلَيْهِ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex59: { name: 'Foam Rolling Hamstrings', reps: 60, type: 'time', description: 'Why: Myofascial release for the back of the thigh. Benefit: Relieves pressure on the lower back caused by tight hamstrings.', image: 'عَنْ عُمَرَ رَضِيَ اللهُ عَنْهُ أَيْضًا قَالَ: " بَيْنَمَا نَحْنُ جُلُوسٌ عِنْدَ رَسُولِ اللَّهِ صلى الله عليه و سلم ذَاتَ يَوْمٍ، إذْ طَلَعَ عَلَيْنَا رَجُلٌ شَدِيدُ بَيَاضِ الثِّيَابِ، شَدِيدُ سَوَادِ الشَّعْرِ، لَا يُرَى عَلَيْهِ أَثَرُ السَّفَرِ، وَلَا يَعْرِفُهُ مِنَّا أَحَدٌ. حَتَّى جَلَسَ إلَى النَّبِيِّ صلى الله عليه و سلم . فَأَسْنَدَ رُكْبَتَيْهِ إلَى رُكْبَتَيْهِ، وَوَضَعَ كَفَّيْهِ عَلَى فَخِذَيْهِ، وَقَالَ: يَا مُحَمَّدُ أَخْبِرْنِي عَنْ الْإِسْلَامِ. فَقَالَ رَسُولُ اللَّهِ صلى الله عليه و سلم الْإِسْلَامُ أَنْ تَشْهَدَ أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَتُقِيمَ الصَّلَاةَ، وَتُؤْتِيَ الزَّكَاةَ، وَتَصُومَ رَمَضَانَ، وَتَحُجَّ الْبَيْتَ إنْ اسْتَطَعْت إلَيْهِ سَبِيلًا. قَالَ: صَدَقْت . فَعَجِبْنَا لَهُ يَسْأَلُهُ وَيُصَدِّقُهُ! قَالَ: فَأَخْبِرْنِي عَنْ الْإِيمَانِ. قَالَ: أَنْ تُؤْمِنَ بِاَللَّهِ وَمَلَائِكَتِهِ وَكُتُبِهِ وَرُسُلِهِ وَالْيَوْمِ الْآخِرِ، وَتُؤْمِنَ بِالْقَدَرِ خَيْرِهِ وَشَرِّهِ. قَالَ: صَدَقْت. قَالَ: فَأَخْبِرْنِي عَنْ الْإِحْسَانِ. قَالَ: أَنْ تَعْبُدَ اللَّهَ كَأَنَّك تَرَاهُ، فَإِنْ لَمْ تَكُنْ تَرَاهُ فَإِنَّهُ يَرَاك. قَالَ: فَأَخْبِرْنِي عَنْ السَّاعَةِ. قَالَ: مَا الْمَسْئُولُ عَنْهَا بِأَعْلَمَ مِنْ السَّائِلِ. قَالَ: فَأَخْبِرْنِي عَنْ أَمَارَاتِهَا؟ قَالَ: أَنْ تَلِدَ الْأَمَةُ رَبَّتَهَا، وَأَنْ تَرَى الْحُفَاةَ الْعُرَاةَ الْعَالَةَ رِعَاءَ الشَّاءِ يَتَطَاوَلُونَ فِي الْبُنْيَانِ. ثُمَّ انْطَلَقَ، فَلَبِثْتُ مَلِيًّا، ثُمَّ قَالَ: يَا عُمَرُ أَتَدْرِي مَنْ السَّائِلُ؟. ‫‬قُلْتُ: اللَّهُ وَرَسُولُهُ أَعْلَمُ. قَالَ: فَإِنَّهُ جِبْرِيلُ أَتَاكُمْ يُعَلِّمُكُمْ دِينَكُمْ ". رَوَاهُ مُسْلِمٌ.' },
  ex21: { name: 'Foam Rolling Calf', reps: 60, type: 'time', description: 'Why: Myofascial release for the lower leg. Benefit: Prevents calf cramps and reduces tension on the Achilles tendon.', image: 'عَنْ أَبِي عَبْدِ الرَّحْمَنِ عَبْدِ اللَّهِ بْنِ عُمَرَ بْنِ الْخَطَّابِ رَضِيَ اللَّهُ عَنْهُمَا قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: " بُنِيَ الْإِسْلَامُ عَلَى خَمْسٍ: شَهَادَةِ أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَإِقَامِ الصَّلَاةِ، وَإِيتَاءِ الزَّكَاةِ، وَحَجِّ الْبَيْتِ، وَصَوْمِ رَمَضَانَ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },

  // Cycle 16: Deep Stretching (Static Anti-Sit)
  ex37: { name: 'Psoas Stretch', reps: 6, type: 'reps', description: 'Why: Targets the deep hip flexor that pulls the spine forward. Benefit: The single most important stretch for reversing the "sitting" posture.', image: 'عَنْ أَبِي عَبْدِ الرَّحْمَنِ عَبْدِ اللَّهِ بْنِ مَسْعُودٍ رَضِيَ اللهُ عَنْهُ قَالَ: حَدَّثَنَا رَسُولُ اللَّهِ صلى الله عليه و سلم -وَهُوَ الصَّادِقُ الْمَصْدُوقُ-: "إنَّ أَحَدَكُمْ يُجْمَعُ خَلْقُهُ فِي بَطْنِ أُمِّهِ أَرْبَعِينَ يَوْمًا نُطْفَةً، ثُمَّ يَكُونُ عَلَقَةً مِثْلَ ذَلِكَ، ثُمَّ يَكُونُ مُضْغَةً مِثْلَ ذَلِكَ، ثُمَّ يُرْسَلُ إلَيْهِ الْمَلَكُ فَيَنْفُخُ فِيهِ الرُّوحَ، وَيُؤْمَرُ بِأَرْبَعِ كَلِمَاتٍ: بِكَتْبِ رِزْقِهِ، وَأَجَلِهِ، وَعَمَلِهِ، وَشَقِيٍّ أَمْ سَعِيدٍ؛ فَوَاَللَّهِ الَّذِي لَا إلَهَ غَيْرُهُ إنَّ أَحَدَكُمْ لَيَعْمَلُ بِعَمَلِ أَهْلِ الْجَنَّةِ حَتَّى مَا يَكُونُ بَيْنَهُ وَبَيْنَهَا إلَّا ذِرَاعٌ فَيَسْبِقُ عَلَيْهِ الْكِتَابُ فَيَعْمَلُ بِعَمَلِ أَهْلِ النَّارِ فَيَدْخُلُهَا. وَإِنَّ أَحَدَكُمْ لَيَعْمَلُ بِعَمَلِ أَهْلِ النَّارِ حَتَّى مَا يَكُ يكونُ بَيْنَهُ وَبَيْنَهَا إلَّا ذِرَاعٌ فَيَسْبِقُ عَلَيْهِ الْكِتَابُ فَيَعْمَلُ بِعَمَلِ أَهْلِ الْجَنَّةِ فَيَدْخُلُهَا". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex28: { name: 'Figure 4 Stretch', reps: 30, type: 'time', description: 'Why: Releases the piriformis and external rotators of the hip. Benefit: Relieves pressure on the sciatic nerve and improves hip comfort.', image: 'عَنْ أُمِّ الْمُؤْمِنِينَ أُمِّ عَبْدِ اللَّهِ عَائِشَةَ رَضِيَ اللَّهُ عَنْهَا، قَالَتْ: قَالَ: رَسُولُ اللَّهِ صلى الله عليه و سلم "مَنْ أَحْدَثَ فِي أَمْرِنَا هَذَا مَا لَيْسَ مِنْهُ فَهُوَ رَدٌّ [رَوَاهُ الْبُخَارِيُّ] ،[وَمُسْلِمٌ] وَفِي رِوَايَةٍ لِمُسْلِمٍ: مَنْ عَمِلَ عَمَلًا لَيْسَ عَلَيْهِ أَمْرُنَا فَهُوَ رَدٌّ".' },
  ex27: { name: 'Torso Rotations', reps: 10, type: 'reps', description: 'Why: Restores rotation to the lumbar and thoracic spine. Benefit: "Defrags" the spine after a long day of static sitting.', image: 'عَنْ أَبِي عَبْدِ اللَّهِ النُّعْمَانِ بْنِ بَشِيرٍ رَضِيَ اللَّهُ عَنْهُمَا، قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: "إنَّ الْحَلَالَ بَيِّنٌ، وَإِنَّ الْحَرَامَ بَيِّنٌ، وَبَيْنَهُمَا أُمُورٌ مُشْتَبِهَاتٌ لَا يَعْلَمُهُنَّ كَثِيرٌ مِنْ النَّاسِ، فَمَنْ اتَّقَى الشُّبُهَاتِ فَقْد اسْتَبْرَأَ لِدِينِهِ وَعِرْضِهِ، وَمَنْ وَقَعَ فِي الشُّبُهَاتِ وَقَعَ فِي الْحَرَامِ، كَالرَّاعِي يَرْعَى حَوْلَ الْحِمَى يُوشِكُ أَنْ يَرْتَعَ فِيهِ، أَلَا وَإِنَّ لِكُلِّ مَلِكٍ حِمًى، أَلَا وَإِنَّ حِمَى اللَّهِ مَحَارِمُهُ، أَلَا وَإِنَّ فِي الْجَسَدِ مُضْغَةً إذَا صَلَحَتْ صَلَحَ الْجَسَدُ كُلُّهُ، وَإذَا فَسَدَتْ فَسَدَ الْجَسَدُ كُلُّهُ، أَلَا وَهِيَ الْقَلْبُ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },


  // Cycle 17: Feet & Calves Recovery
  ex47: { name: 'Banded Ankle Mobilisation', reps: 60, type: 'time', description: 'Why: Uses a band to pull the talus bone back. Benefit: Directly improves "ankle dorsiflexion" (the ability to pull the toes up), which is crucial for a healthy stride.', image: 'عَنْ أَبِي رُقَيَّةَ تَمِيمِ بْنِ أَوْسٍ الدَّارِيِّ رَضِيَ اللهُ عَنْهُ أَنَّ النَّبِيَّ صلى الله عليه وسلم قَالَ: "الدِّينُ النَّصِيحَةُ." قُلْنَا: لِمَنْ؟ قَالَ: "لِلَّهِ، وَلِكِتَابِهِ، وَلِرَسُولِهِ، وَلِأَئِمَّةِ الْمُسْلِمِينَ وَعَامَّتِهِمْ." رَوَاهُ مُسْلِمٌ.' },
  ex60: { name: 'Heel-toe Walks', reps: 15, type: 'reps', description: 'Why: Trains the coordination of the lower leg muscles. Benefit: Strengthens the tibialis anterior and calves for improved foot landing.', image: 'عَنْ ابْنِ عُمَرَ رَضِيَ اللَّهُ عَنْهُمَا، أَنَّ رَسُولَ اللَّهِ صلى الله عليه و سلم قَالَ: "أُمِرْتُ أَنْ أُقَاتِلَ النَّاسَ حَتَّى يَشْهَدُوا أَنْ لَا إلَهَ إلَّا اللَّهُ وَأَنَّ مُحَمَّدًا رَسُولُ اللَّهِ، وَيُقِيمُوا الصَّلَاةَ، وَيُؤْتِيَ الزَّكَاةَ؛ فَإِذَا فَعَلُوا ذَلِكَ عَصَمُوا مِنِّي دِمَاءَهُمْ وَأَمْوَالَهُمْ إلَّا بِحقِّ الْإِسْلَامِ، وَحِسَابُهُمْ عَلَى اللَّهِ تَعَالَى" . رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' },
  ex31: { name: 'Ankle Circles', reps: 10, type: 'reps', description: 'Why: Improves synovial fluid flow in the ankle joint. Benefit: Reduces morning stiffness and improves joint health.', image: 'عَنْ أَبِي هُرَيْرَةَ عَبْدِ الرَّحْمَنِ بْنِ صَخْرٍ رَضِيَ اللهُ عَنْهُ قَالَ: سَمِعْت رَسُولَ اللَّهِ صلى الله عليه و سلم يَقُولُ: "مَا نَهَيْتُكُمْ عَنْهُ فَاجْتَنِبُوهُ، وَمَا أَمَرْتُكُمْ بِهِ فَأْتُوا مِنْهُ مَا اسْتَطَعْتُمْ، فَإِنَّمَا أَهْلَكَ الَّذِينَ مِنْ قَبْلِكُمْ كَثْرَةُ مَسَائِلِهِمْ وَاخْتِلَافُهُمْ عَلَى أَنْبِيَائِهِمْ ". رَوَاهُ الْبُخَارِيُّ وَمُسْلِمٌ.' }
};

// This is the working catalog that will be used
let localCatalog = { ...catalog };

let currentExerciseIndex = 0; // Tracks the current exercise group index
let exerciseCompleted = {};

// Robust storage helper with multiple fallbacks for better persistence
const AppStorage = {
  dbName: 'TimeoutMuscleDB',
  storeName: 'state',
  key: 'muscleState',

  save: async function (data) {
    // Try IndexedDB first
    try {
      const idbSuccess = await this.saveIndexedDB(data);
      if (idbSuccess) return true;
    } catch (e) {
      console.warn('IndexedDB save failed:', e);
    }

    // Fallback to localStorage
    try {
      localStorage.setItem(this.key, JSON.stringify(data));
      // Removed debug log
      return true;
    } catch (e) {
      console.warn('localStorage save failed:', e);
    }

    // Fallback to sessionStorage
    try {
      sessionStorage.setItem(this.key, JSON.stringify(data));
      // Removed debug log
      return true;
    } catch (e) {
      console.warn('sessionStorage save failed:', e);
    }

    // Fallback to cookies
    try {
      this.saveCookie(data);
      // Removed debug log
      return true;
    } catch (e) {
      console.warn('Cookie save failed:', e);
    }

    // Fallback to URL hash
    try {
      this.saveHash(data);
      // Removed debug log
      return true;
    } catch (e) {
      console.warn('Hash save failed:', e);
    }

    // Removed debug log
    return false;
  },

  load: async function () {
    // Try IndexedDB first
    try {
      const idbData = await this.loadIndexedDB();
      if (idbData) {
        // Removed debug log
        return idbData;
      }
    } catch (e) {
      console.warn('IndexedDB load failed:', e);
    }

    // Fallback to localStorage
    try {
      const lsData = localStorage.getItem(this.key);
      if (lsData) {
        // Removed debug log
        return JSON.parse(lsData);
      }
    } catch (e) {
      console.warn('localStorage load failed:', e);
    }

    // Fallback to sessionStorage
    try {
      const ssData = sessionStorage.getItem(this.key);
      if (ssData) {
        // Removed debug log
        return JSON.parse(ssData);
      }
    } catch (e) {
      console.warn('sessionStorage load failed:', e);
    }

    // Fallback to cookies
    try {
      const cookieData = this.loadCookie();
      if (cookieData) {
        // Removed debug log
        return cookieData;
      }
    } catch (e) {
      console.warn('Cookie load failed:', e);
    }

    // Fallback to URL hash
    try {
      const hashData = this.loadHash();
      if (hashData) {
        // Removed debug log
        return hashData;
      }
    } catch (e) {
      console.warn('Hash load failed:', e);
    }

    return null;
  },

  // Helper methods for IndexedDB
  saveIndexedDB: function (data) {
    return new Promise((resolve) => {
      const request = indexedDB.open(this.dbName, 1);
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          db.createObjectStore(this.storeName);
        }
      };
      request.onsuccess = (e) => {
        const db = e.target.result;
        const transaction = db.transaction(this.storeName, 'readwrite');
        const store = transaction.objectStore(this.storeName);
        store.put(data, this.key);
        transaction.oncomplete = () => {
          // Removed debug log
          resolve(true);
        };
        transaction.onerror = () => resolve(false);
      };
      request.onerror = () => resolve(false);
    });
  },

  loadIndexedDB: function () {
    return new Promise((resolve) => {
      const request = indexedDB.open(this.dbName, 1);
      request.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(this.storeName)) {
          db.createObjectStore(this.storeName);
        }
      };
      request.onsuccess = (e) => {
        const db = e.target.result;
        const transaction = db.transaction(this.storeName, 'readonly');
        const store = transaction.objectStore(this.storeName);
        const getRequest = store.get(this.key);
        getRequest.onsuccess = () => resolve(getRequest.result);
        getRequest.onerror = () => resolve(null);
      };
      request.onerror = () => resolve(null);
    });
  },

  // Cookie fallback
  saveCookie: function (data) {
    const expired = new Date();
    expired.setFullYear(expired.getFullYear() + 1);
    document.cookie = `${this.key}=${encodeURIComponent(JSON.stringify(data))}; expires=${expired.toUTCString()}; path=/`;
  },

  loadCookie: function () {
    const name = this.key + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const ca = decodedCookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) == ' ') { c = c.substring(1); }
      if (c.indexOf(name) == 0) {
        return JSON.parse(c.substring(name.length, c.length));
      }
    }
    return null;
  },

  // URL Hash fallback
  saveHash: function (data) {
    window.location.hash = encodeURIComponent(JSON.stringify(data));
  },
  loadHash: function () {
    if (!window.location.hash) return null;
    try {
      return JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
    } catch (e) {
      return null;
    }
  }
};



async function saveState() {
  const state = {
    catalog: localCatalog,
    index: currentExerciseIndex,
    completed: exerciseCompleted
  };
  await AppStorage.save(state);
}

async function loadState() {
  const savedState = await AppStorage.load();
  if (savedState) {
    localCatalog = savedState.catalog || localCatalog;
    currentExerciseIndex = savedState.index || 0;
    exerciseCompleted = savedState.completed || {};

    // Check if the current catalog matches the default catalog structure
    // If we've added new default exercises, we should merge them in
    let hasChanges = false;
    for (const key in catalog) {
      if (!localCatalog[key]) {
        localCatalog[key] = { ...catalog[key] };
        hasChanges = true;
      }
    }

    if (hasChanges) {
      saveState();
    }
  }
}

function getCatalogKeys() {
  return Object.keys(localCatalog).filter(key => typeof localCatalog[key] !== 'function');
}

function getTotalGroups() {
  const keys = getCatalogKeys();
  return Math.ceil(keys.length / EXERCISES_PER_BREAK);
}

function validateCatalog() {
  const keys = getCatalogKeys();
  if (keys.length === 0) {
    localCatalog = { ...catalog };
    currentExerciseIndex = 0;
    saveState();
  }
}

function validateCurrentExercise() {
  const totalGroups = getTotalGroups();
  if (currentExerciseIndex >= totalGroups) {
    currentExerciseIndex = 0;
    saveState();
  }
}

if (resetButton) {
  resetButton.addEventListener('click', function () {
    localCatalog = { ...catalog };
    currentExerciseIndex = 0;
    exerciseCompleted = {};
    saveState();
    displayExercise();
    displayCatalog();
  });
}

// Create HTML elements for catalog
function displayCatalog() {
  // Clear existing dl elements
  let existingDls = catalogBox.querySelectorAll('dl');
  existingDls.forEach(el => el.remove());

  // Check if close button exists, if not create it
  if (!catalogBox.querySelector('.close-button')) {
    let closeButton = document.createElement('button');
    closeButton.innerHTML = '×';
    closeButton.className = 'close-button';
    closeButton.addEventListener('click', function () {
      catalogBox.style.display = 'none';
    });
    // Append to the header instead of the box root
    catalogBox.querySelector('.catalog-header').appendChild(closeButton);
  }

  const keys = getCatalogKeys();
  keys.forEach(item => {
    let exerciseSet = document.createElement('dl'),
      nameBox = document.createElement('dt'),
      repsBox = document.createElement('dd'),
      typeBox = document.createElement('dd'),
      descBox = document.createElement('dd');

    exerciseSet.setAttribute('data-item', item);

    nameBox.contentEditable = true;
    repsBox.contentEditable = true;
    typeBox.contentEditable = true;
    descBox.contentEditable = true;

    nameBox.setAttribute('data-item', 'name');
    repsBox.setAttribute('data-item', 'reps');
    typeBox.setAttribute('data-item', 'type');
    descBox.setAttribute('data-item', 'description');

    nameBox.textContent = localCatalog[item].name;
    repsBox.textContent = localCatalog[item].reps;
    typeBox.textContent = localCatalog[item].type || 'reps';
    descBox.textContent = localCatalog[item].description || 'Desc';

    // Catalog styling logic is now handled by CSS classes mostly
    exerciseSet.appendChild(nameBox);
    exerciseSet.appendChild(repsBox);
    exerciseSet.appendChild(typeBox);
    exerciseSet.appendChild(descBox);
    catalogBox.appendChild(exerciseSet);

    // Dynamic update logic
    [nameBox, repsBox, typeBox, descBox].forEach(box => {
      box.addEventListener('blur', function () {
        const field = this.getAttribute('data-item');
        localCatalog[item][field] = this.textContent;
        saveState();
        displayExercise(); // Update main display too
      });
    });
  });

  // Update button logic (prevent duplication)
  if (!catalogBox.querySelector('.add-button')) {
    let addButton = document.createElement('button');
    addButton.innerHTML = '+ ADD NEW';
    addButton.className = 'action-button complete-button add-button'; // Reuse classes
    addButton.style.marginTop = '20px'; // Minor adjustment

    addButton.addEventListener('click', function () {
      let keys = getCatalogKeys();
      let highestNum = 0;
      keys.forEach(key => {
        let num = parseInt(key.replace('ex', ''));
        if (!isNaN(num) && num > highestNum) highestNum = num;
      });
      let newId = 'ex' + (highestNum + 1).toString().padStart(2, '0');
      localCatalog[newId] = { name: 'New Exercise', reps: 10, type: 'reps', description: 'Desc', image: '' };
      saveState();
      displayCatalog();
    });
    catalogBox.appendChild(addButton);
  }
}

function getCurrentExerciseGroup() {
  validateCatalog();
  validateCurrentExercise();

  const keys = getCatalogKeys();
  const startIndex = currentExerciseIndex * EXERCISES_PER_BREAK;
  const group = [];

  for (let i = 0; i < EXERCISES_PER_BREAK; i++) {
    const key = keys[startIndex + i];
    if (!key) break;

    const exercise = localCatalog[key] || {};
    group.push({
      id: key,
      name: exercise.name,
      reps: exercise.reps,
      type: exercise.type || 'reps',
      description: exercise.description || '',
      image: exercise.image || ''
    });
  }

  // Removed debug log
  return group;
}

function completeCurrentExercise() {
  const keys = getCatalogKeys();
  if (keys.length === 0) {
    return;
  }

  const startIndex = currentExerciseIndex * EXERCISES_PER_BREAK;
  for (let i = 0; i < EXERCISES_PER_BREAK; i++) {
    const key = keys[startIndex + i];
    if (!key) break;
    exerciseCompleted[key] = true;
  }

  currentExerciseIndex++;
  const totalGroups = getTotalGroups();
  if (currentExerciseIndex >= totalGroups) {
    currentExerciseIndex = 0;
  }

  saveState(); // Saves the NEXT group index

  // Fade out current content
  const currentContent = document.querySelector('.exercise-content');
  if (currentContent) {
    currentContent.style.opacity = '0';
    setTimeout(() => {
      displayExercise();
      // Fade in new content
      setTimeout(() => {
        const newContent = document.querySelector('.exercise-content');
        if (newContent) newContent.style.opacity = '1';
      }, 10);
    }, 300);
  } else {
    displayExercise();
    setTimeout(() => {
      const newContent = document.querySelector('.exercise-content');
      if (newContent) newContent.style.opacity = '1';
    }, 10);
  }
}

function displayExercise() {
  const currentGroup = getCurrentExerciseGroup();
  const totalGroups = getTotalGroups();
  const allKeys = getCatalogKeys();

  let exerciseContent = '<div class="exercise-content">';

  exerciseContent += `
    <div class="exercise-top-bar">
      <div class="progress-indicator">مجموعة ${currentExerciseIndex + 1} من ${totalGroups}</div>
      <button id="complete-btn" class="action-button complete-button">التالي</button>
    </div>
  `;

  if (currentGroup.length === 0) {
    exerciseContent += '<div class="exercise-empty">No exercises configured. Add some in settings.</div>';
  } else {
    exerciseContent += '<div class="exercise-list">';

    currentGroup.forEach((exercise, index) => {
      const sequenceNumber = currentExerciseIndex * EXERCISES_PER_BREAK + index + 1;
      const multiplierStr = exercise.type === 'time' ? 'ثانية' : 'تكرار';
      const repsDisplay = (exercise.reps === undefined || exercise.reps === null) ? '' : exercise.reps;

      exerciseContent += '<div class="exercise-item">';
      exerciseContent += `<div class="exercise-sequence">${sequenceNumber} / ${allKeys.length}</div>`;

      if (exercise.image) {
        if (exercise.image.startsWith('http')) {
          exerciseContent += `<div class="exercise-image">
            <img src="${exercise.image}" alt="${exercise.name}">
          </div>`;
        } else {
          exerciseContent += `<div class="exercise-hadith">
            ${exercise.image}
          </div>`;
        }
      }

      exerciseContent += `<div class="exercise-header">
        <div class="exercise-name">${exercise.name}</div>
        <button class="info-trigger" data-id="${exercise.id}">?</button>
        <div id="tooltip-${exercise.id}" class="description-tooltip">
          ${exercise.reps || exercise.type ? `
            <div class="exercise-stats">
              <span class="exercise-meta">${repsDisplay}</span>
              <span class="multiplier">${multiplierStr}</span>
            </div>
          ` : ''}
          <div class="exercise-description">${exercise.description}</div>
        </div>
      </div>`;

      exerciseContent += '</div>'; // .exercise-item
    });

    exerciseContent += '</div>'; // .exercise-list
  }

  exerciseContent += '</div>'; // .exercise-content

  displayBox.innerHTML = exerciseContent;
  addActionButtonListeners();
}

function addActionButtonListeners() {
  const completeBtn = document.getElementById('complete-btn');

  if (completeBtn) {
    // Clone and replace is a good way to remove old listeners
    const newBtn = completeBtn.cloneNode(true);
    completeBtn.parentNode.replaceChild(newBtn, completeBtn);
    newBtn.addEventListener('click', function () {
      newBtn.innerHTML = '<div class="spinner"></div>';
      newBtn.disabled = true;
      completeCurrentExercise();
    });
  }

  // Tooltip Toggle Logic
  document.querySelectorAll('.info-trigger').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.stopPropagation();
      const id = this.getAttribute('data-id');
      const tooltip = document.getElementById(`tooltip-${id}`);

      // Close other tooltips
      document.querySelectorAll('.description-tooltip').forEach(t => {
        if (t !== tooltip) t.classList.remove('active');
      });

      tooltip.classList.toggle('active');
    });
  });
}

// Close tooltips when clicking elsewhere (added once)
document.addEventListener('click', () => {
  document.querySelectorAll('.description-tooltip').forEach(t => {
    t.classList.remove('active');
  });
});

// Init
async function init() {
  // 1. Load state FIRST, before any other logic.
  await loadState();
  // 2. Validate catalog size and index
  validateCatalog();
  // 3. Display the exercise based on the loaded index
  displayExercise();
  // 4. Fade in content
  setTimeout(() => {
    const content = document.querySelector('.exercise-content');
    if (content) content.style.opacity = '1';
  }, 10);
  // 5. Build catalog for settings popup
  displayCatalog();
}

// Call init
init();

// Add 'loaded' class
window.onload = function (e) {
  document.body.className = 'loaded';
};
